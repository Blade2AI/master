<#!
.SYNOPSIS
  Perform network anchoring for a sealed manifest.
.DESCRIPTION
  Default: Dry-run (no network writes). Live only if all guards pass:
    - -Live switch
    - ANCHOR_ENV=prod
    - NFT_STORAGE_API_KEY present
    - BUNDLR_KEY_PATH present and file exists
    - <manifest>.sig.json exists (signature receipt)
.PARAMETER ManifestPath
  Path to anchor JSON manifest (event_anchor_*.json)
.PARAMETER Live
  Request live anchoring (guarded)
.PARAMETER DryRun
  Force dry-run regardless of Live
#>
[CmdletBinding()]param(
  [Parameter(Mandatory=$true)][string]$ManifestPath,
  [switch]$Live,
  [switch]$DryRun
)
$ErrorActionPreference='Stop'
Write-Host '== Perform-NetworkAnchoring ==' -ForegroundColor Cyan
Write-Host "Manifest : $ManifestPath"
Write-Host ("Live     : {0}" -f $Live.IsPresent)
Write-Host ("DryRun   : {0}" -f $DryRun.IsPresent)

if(-not (Test-Path $ManifestPath)){ throw "Manifest not found: $ManifestPath" }
$manifest = Get-Content -LiteralPath $ManifestPath -Raw | ConvertFrom-Json
$anchorId = $manifest.anchor_id; if(-not $anchorId){ $anchorId = [IO.Path]::GetFileNameWithoutExtension($ManifestPath) }
$rootHash = $manifest.root_hash

# Safety-first: sign + PII guardrail (always run prior to evaluating live)
try {
  Write-Host '[ANCHOR] Signing + PII guardrail...' -ForegroundColor Cyan
  python scripts/sign_anchor.py --anchor $ManifestPath
  if($LASTEXITCODE -ne 0){ throw 'sign_anchor.py returned non-zero' }
  Write-Host '[ANCHOR] Signature OK.' -ForegroundColor Green
} catch { throw "[ABORT] Signing/guard failed: $_" }

$effectiveDryRun = $true
$fallbackReasons = @()

if($DryRun){ $fallbackReasons += 'EXPLICIT_DRYRUN' }
elseif(-not $Live){ $fallbackReasons += 'LIVE_FLAG_NOT_SET' }
else {
  if($env:ANCHOR_ENV -ne 'prod'){ $fallbackReasons += 'ANCHOR_ENV_NOT_PROD' }
  if([string]::IsNullOrWhiteSpace($env:NFT_STORAGE_API_KEY)){ $fallbackReasons += 'MISSING_NFT_STORAGE_API_KEY' }
  $bundlrKeyPath = $env:BUNDLR_KEY_PATH
  if([string]::IsNullOrWhiteSpace($bundlrKeyPath) -or -not (Test-Path $bundlrKeyPath)){ $fallbackReasons += 'MISSING_OR_INVALID_BUNDLR_KEY' }
  $sigPath = [IO.Path]::ChangeExtension($ManifestPath,'.sig.json')
  if(-not (Test-Path $sigPath)){ $fallbackReasons += 'MISSING_SIGNATURE_FILE' }
  if($fallbackReasons.Count -eq 0){ $effectiveDryRun = $false }
}

if($effectiveDryRun){
  Write-Host 'Mode     : DRY-RUN' -ForegroundColor Yellow
  if($fallbackReasons.Count -gt 0){ Write-Host "Guards   : $($fallbackReasons -join ', ')" -ForegroundColor DarkYellow }
} else { Write-Host 'Mode     : LIVE (ALL GUARDS PASSED)' -ForegroundColor Green }

# Network anchoring stubs / real implementations go here
$txId = $null; $cid = $null
if(-not $effectiveDryRun){
  try {
    # TODO: Replace with real Bundlr/IPFS clients
    Write-Host '[LIVE] Uploading to Arweave (Bundlr)...' -ForegroundColor Cyan
    $txId = 'bundlr-' + ($anchorId.Substring(0,32))
    Write-Host "[LIVE] Arweave TXID: $txId" -ForegroundColor Green

    Write-Host '[LIVE] Uploading to IPFS (nft.storage)...' -ForegroundColor Cyan
    $cid = 'bafy' + ($anchorId.Substring(0,10))
    Write-Host "[LIVE] IPFS CID: $cid" -ForegroundColor Green
  } catch { Write-Host "[ERROR] Live upload failure: $_" -ForegroundColor Red; $fallbackReasons += 'UPLOAD_EXCEPTION'; $effectiveDryRun=$true }
}

if(-not $effectiveDryRun -and $txId -and $cid){
  $eventPayload = @{
    anchor_id   = $anchorId
    root_hash   = $rootHash
    tx_id       = $txId
    cid         = $cid
    created_utc = (Get-Date).ToUniversalTime().ToString('o')
    manifest    = $ManifestPath
  }
  $eventPath = Join-Path (Split-Path $ManifestPath -Parent) ("event_anchor_created_$anchorId.json")
  $eventPayload | ConvertTo-Json -Depth 5 | Set-Content -LiteralPath $eventPath -Encoding UTF8
  $writeEvent = 'scripts/Write-Event.ps1'
  if(Test-Path $writeEvent){ try { & $writeEvent -EventType 'event_anchor_created' -Payload @{ anchor_id=$anchorId; root_hash=$rootHash; tx_id=$txId; cid=$cid; created_utc=$eventPayload.created_utc } } catch { Write-Host "[WARN] Event emission failed: $_" -ForegroundColor Yellow } }
  Write-Host ("[ANCHOR-LIVE-01] MODE=LIVE anchor_id={0} tx_id={1} cid={2} root={3}" -f $anchorId,$txId,$cid,$rootHash) -ForegroundColor Green
} else {
  Write-Host '[ANCHOR] No live receipts (dry-run or guard failure).' -ForegroundColor Yellow
  Write-Host ("[ANCHOR-LIVE-01] MODE=DRYRUN anchor_id={0} root={1} reasons={2}" -f $anchorId,$rootHash,($fallbackReasons -join '|')) -ForegroundColor Yellow
}
