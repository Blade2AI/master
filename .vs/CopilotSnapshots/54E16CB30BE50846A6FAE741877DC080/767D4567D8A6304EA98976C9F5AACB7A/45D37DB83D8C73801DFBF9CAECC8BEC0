# modules/Meeting-Engine.psm1
# Minimal Meeting Engine: builds meeting records from spec and writes to disk

function Invoke-SovMeeting {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)][string]$Type,
        [Parameter(Mandatory)][hashtable]$Context
    )

    $dir = "C:\BladeOps\Meetings"
    if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }

    $meetingId = "MEET-{0}-{1:0000}" -f (Get-Date -Format "yyyyMMddHHmmss"), (Get-Random -Minimum 1 -Maximum 9999)
    $meeting = [pscustomobject]@{
        meeting_id = $meetingId
        type = $Type
        context = $Context
        participants = @()
        decisions = @()
        actions = @()
        created_at = (Get-Date).ToString('o')
    }

    # Attempt to cryptographically sign the meeting record
    if (Get-Command -Name New-MessageSignature -ErrorAction SilentlyContinue) {
        try {
            $sig = New-MessageSignature -Data $meeting
            if ($sig) { $meeting.signature = $sig }
        } catch {
            Write-Warning "Meeting signing failed: $_"
        }
    } else {
        Write-Host "Warning: New-MessageSignature not available — meeting will be unsigned" -ForegroundColor Yellow
    }

    $outPath = Join-Path $dir ("$meetingId.json")
    $tmpPath = "$outPath.tmp"

    # Write atomically
    $meeting | ConvertTo-Json -Depth 10 | Out-File $tmpPath -Encoding UTF8
    Move-Item -LiteralPath $tmpPath -Destination $outPath -Force

    if (Get-Command -Name Log-GovernanceEvent -ErrorAction SilentlyContinue) {
        $logEvent = @{ type = 'MEETING_HELD'; message = "Meeting $meetingId of type $Type held"; meeting_id = $meetingId }
        if ($meeting.PSObject.Properties.Match('signature')) { $logEvent.signature = $meeting.signature.signature }
        Log-GovernanceEvent $logEvent
    }

    return $meeting
}

function New-SovDailyStandup {
    [CmdletBinding()]
    param(
        [string]$Team = "DEFAULT",
        [string]$UserId = "andy"
    )

    # Attempt to gather vibrational context
    $triad = $null
    if (Get-Command -Name Invoke-VibrationalTriad -ErrorAction SilentlyContinue) {
        try {
            $triad = Invoke-VibrationalTriad -UserId $UserId
        } catch {
            Write-StepWarning "Invoke-VibrationalTriad failed: $_"
        }
    }

    $context = [ordered]@{
        team = $Team
        created_at = (Get-Date).ToString('o')
    }

    if ($triad) {
        $context.vibration_map = $triad.metrics
        $context.high_queue = $triad.high_queue
        $context.neutral_queue = $triad.neutral_queue
        $context.low_queue = $triad.low_queue
        $context.meeting_seeds = $triad.signals.meeting_seeds
    } else {
        $context.note = "No vibrational data available"
    }

    $meeting = Invoke-SovMeeting -Type "DAILY_CELL_STANDUP" -Context $context
    return $meeting
}

Export-ModuleMember -Function *
