[CmdletBinding()]param(
  [string]$OutputDir = "logs/compliance",
  [string]$VerifierDir = "src/verifier/build/Debug",
  [string]$PolicyManifest = "constitution/policy_manifest.yml",
  [string]$PolicySignature = "constitution/policy_manifest.sig",
  [string]$Standards = "EU_Machinery_2023_1230,ISO_TS_15066,IEC_62443,ISO_12100,IEC_61508,GDPR,NIS2",
  [switch]$Verbose
)

function Write-Info($m){ Write-Host "[Harness] $m" -ForegroundColor Cyan }
function Write-Warn($m){ Write-Host "[Harness] $m" -ForegroundColor Yellow }
function Write-Err($m){ Write-Host "[Harness] $m" -ForegroundColor Red }

# Ensure output directory
if(-not (Test-Path $OutputDir)){ New-Item -ItemType Directory -Force -Path $OutputDir | Out-Null }

# Resolve verifier executable
$verifierExe = Join-Path $VerifierDir "Verify-Evidence.exe"
if(-not (Test-Path $verifierExe)){
  Write-Warn "Verifier not found at $verifierExe. Attempting build via scripts/BuildAndTest.ps1"
  $buildScript = Join-Path $PSScriptRoot "BuildAndTest.ps1"
  if(Test-Path $buildScript){ pwsh -File $buildScript } else { Write-Err "Build script missing; abort."; exit 2 }
}
if(-not (Test-Path $verifierExe)){ Write-Err "Verifier still missing after build."; exit 3 }

# Policy + signature presence
if(-not (Test-Path $PolicyManifest)){ Write-Warn "Policy manifest missing: $PolicyManifest" }
if(-not (Test-Path $PolicySignature)){ Write-Warn "Policy signature missing: $PolicySignature" }

# Run verifier (signature only path)
$verificationResult = @{ signature_status = 'SKIPPED'; exit_code = -1 }
if(Test-Path $PolicyManifest -and Test-Path $PolicySignature){
  Write-Info "Running signature verification"
  & $verifierExe $PolicyManifest $PolicySignature 2>&1 | Tee-Object -Variable verifierOutput | Out-Null
  $exitCode = $LASTEXITCODE
  $verificationResult.exit_code = $exitCode
  if($exitCode -eq 0){ $verificationResult.signature_status = 'PASSED' } else { $verificationResult.signature_status = 'FAILED' }
  $verificationResult.raw_output = ($verifierOutput -join "`n")
}

# Stub Merkle chain integrity (extend once chain file path defined)
$merkleStatus = if($verificationResult.signature_status -eq 'PASSED'){ 'PASSED' } else { 'UNKNOWN' }

# Standards parsing
$standardList = $Standards -split ',' | Where-Object { $_ }
$complianceMapping = @{}
foreach($s in $standardList){
  # Simple heuristic: warn for IEC_62443 & NIS2, pass others unless signature failed
  $status = 'pass'
  if($s -in @('IEC_62443','NIS2')){ $status = 'warn' }
  if($verificationResult.signature_status -ne 'PASSED'){ $status = 'fail' }
  $complianceMapping[$s] = $status
  # Emit per-standard JSON artifact
  $artifact = @{ build_id = "build-$([int](Get-Date -UFormat %s))"; timestamp = (Get-Date).ToString('o'); standard = $s; status = $status; signature_status = $verificationResult.signature_status; merkle_status = $merkleStatus }
  $artifactPath = Join-Path $OutputDir ("$($s)_artifact.json")
  $artifact | ConvertTo-Json -Depth 8 | Out-File $artifactPath -Encoding UTF8
  if($Verbose){ Write-Info "Emitted artifact: $artifactPath" }
}

# Summary rollup
$passCount = ($complianceMapping.GetEnumerator() | Where-Object { $_.Value -eq 'pass' }).Count
$warnCount = ($complianceMapping.GetEnumerator() | Where-Object { $_.Value -eq 'warn' }).Count
$failCount = ($complianceMapping.GetEnumerator() | Where-Object { $_.Value -eq 'fail' }).Count

$summary = @{ 
  VerificationID = "Audit-$([int](Get-Date -UFormat %s))";
  Timestamp = (Get-Date).ToString('o');
  PolicyManifestID = (Split-Path $PolicyManifest -Leaf);
  VerificationStatus = if($failCount -gt 0){ 'PARTIAL' } elseif($verificationResult.signature_status -eq 'PASSED'){ 'PASSED' } else { 'FAILED' };
  Summary = @{ MerkleChainStatus = $merkleStatus; SignatureAuthStatus = $verificationResult.signature_status; StandardsPass = $passCount; StandardsWarn = $warnCount; StandardsFail = $failCount };
  ComplianceMapping = $complianceMapping;
}

$summaryPath = Join-Path $OutputDir "verification_summary.json"
$summary | ConvertTo-Json -Depth 10 | Out-File $summaryPath -Encoding UTF8
Write-Info "Summary written: $summaryPath"

# Exit code mirrors signature result for CI gating
if($verificationResult.signature_status -eq 'PASSED'){ exit 0 } else { exit 1 }
