param(
  [Parameter(Mandatory=$true)][Alias('Input','Urls')][object]$Inputs,
  [string]$OutDir = "${env:USERPROFILE}\Documents\Sovereign\Transcripts",
  [string]$Model = "base",
  [int]$SplitParts = 2
)

function Ensure-Dir($p){ if(-not (Test-Path $p)){ New-Item -ItemType Directory -Force -Path $p | Out-Null } }
function Split-Inputs([object]$raw){
  if($raw -is [Array]){ return @($raw | ForEach-Object { $_.ToString() }) }
  $s = $raw.ToString()
  return @($s -split "[,;\r\n]" | Where-Object { $_ -and $_.Trim() -ne '' } | ForEach-Object { $_.Trim() })
}
function Download-IfUrl([string]$src){
  if($src -match '^(https?|file)://'){
    $yt = Get-Command yt-dlp -ErrorAction SilentlyContinue
    if(-not $yt){ throw "yt-dlp not found. Install it or download media manually." }
    $tmp = Join-Path $env:TEMP ("sv_" + [guid]::NewGuid().ToString() + ".mp4")
    & $yt.Source $src -o $tmp | Write-Output
    if(-not (Test-Path $tmp)){ throw "yt-dlp failed to download: $src" }
    return ,@($tmp,$true)
  }
  if(-not (Test-Path $src)){ throw "Input not found: $src" }
  return ,@((Resolve-Path $src).Path,$false)
}

Ensure-Dir $OutDir

$whisper = Get-Command whisper -ErrorAction SilentlyContinue
if(-not $whisper){ throw "whisper CLI not found. Install: pip install openai-whisper (ffmpeg required)." }

$allText = New-Object System.Collections.Generic.List[string]
$tempsToDelete = @()

$items = Split-Inputs $Inputs
if(-not $items -or $items.Count -eq 0){ throw "No inputs provided." }

$idx = 0
foreach($item in $items){
  $idx++
  $local, $isTemp = Download-IfUrl $item
  if($isTemp){ $tempsToDelete += $local }

  & $whisper.Source $local --model $Model --task transcribe --output_dir $OutDir --verbose False --fp16 False | Write-Output

  $base = [System.IO.Path]::GetFileNameWithoutExtension($local)
  $txt = Join-Path $OutDir ("$base.txt")
  if(-not (Test-Path $txt)){
    $cand = Get-ChildItem -Path $OutDir -Filter "*.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    if($cand){ $txt = $cand.FullName } else { throw "Transcript .txt not found in $OutDir for $local" }
  }
  $srcLabel = if($item -match '^(https?|file)://'){ $item } else { $local }
  $allText.Add("===== Source ${idx}: ${srcLabel} =====")
  $allText.Add((Get-Content -LiteralPath $txt -Raw))
}

$stamp = (Get-Date -Format 'yyyyMMdd_HHmmss')
$mergedPath = Join-Path $OutDir ("merged_transcript_${stamp}.txt")
$allText -join [Environment]::NewLine | Out-File -LiteralPath $mergedPath -Encoding UTF8

if($SplitParts -gt 1){
  $content = Get-Content -LiteralPath $mergedPath -Raw
  $lines = $content -split "\r?\n"
  $mid = [int]([math]::Floor($lines.Length/2))
  $p1 = $lines[0..($mid-1)] -join [Environment]::NewLine
  $p2 = $lines[$mid..($lines.Length-1)] -join [Environment]::NewLine
  $out1 = Join-Path $OutDir ("merged_transcript_${stamp}.part1.txt")
  $out2 = Join-Path $OutDir ("merged_transcript_${stamp}.part2.txt")
  Set-Content -LiteralPath $out1 -Value $p1 -Encoding UTF8
  Set-Content -LiteralPath $out2 -Value $p2 -Encoding UTF8
  Write-Host "Merged transcript:" $mergedPath -ForegroundColor Green
  Write-Host "Part1:" $out1 -ForegroundColor Green
  Write-Host "Part2:" $out2 -ForegroundColor Green
} else {
  Write-Host "Merged transcript:" $mergedPath -ForegroundColor Green
}

foreach($t in $tempsToDelete){ if(Test-Path $t){ Remove-Item -LiteralPath $t -Force -ErrorAction SilentlyContinue } }
