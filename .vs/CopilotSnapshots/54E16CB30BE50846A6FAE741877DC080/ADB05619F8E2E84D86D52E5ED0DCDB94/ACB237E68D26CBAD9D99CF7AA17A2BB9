param(
  [Parameter(Mandatory=$true)][string]$Input,
  [string]$OutDir = "${env:USERPROFILE}\Documents\Sovereign\Transcripts",
  [string]$Model = "base",
  [int]$SplitParts = 2
)

function Ensure-Dir($p){ if(-not (Test-Path $p)){ New-Item -ItemType Directory -Force -Path $p | Out-Null } }
Ensure-Dir $OutDir

$workFile = $null
$isUrl = $Input -match '^(https?|file)://'

if($isUrl){
  # Try yt-dlp if present
  $yt = Get-Command yt-dlp -ErrorAction SilentlyContinue
  if($null -ne $yt){
    $tmp = Join-Path $env:TEMP ("sv_" + [guid]::NewGuid().ToString() + ".mp4")
    & $yt.Source $Input -o $tmp | Write-Output
    if(-not (Test-Path $tmp)){ throw "yt-dlp failed to download: $Input" }
    $workFile = $tmp
  } else {
    throw "No downloader found. Install yt-dlp or download the media locally and pass a file path."
  }
}
else {
  if(-not (Test-Path $Input)){ throw "Input not found: $Input" }
  $workFile = (Resolve-Path $Input).Path
}

# Check whisper CLI
$whisper = Get-Command whisper -ErrorAction SilentlyContinue
if($null -eq $whisper){
  throw "whisper CLI not found. Install with: pip install openai-whisper && ensure ffmpeg is on PATH."
}

# Transcribe
& $whisper.Source $workFile --model $Model --task transcribe --output_dir $OutDir --verbose False --fp16 False | Write-Output

$base = [System.IO.Path]::GetFileNameWithoutExtension($workFile)
$txt = Join-Path $OutDir ("$base.txt")
if(-not (Test-Path $txt)){
  # Some versions name with language suffix; try to find a .txt emitted recently
  $cand = Get-ChildItem -Path $OutDir -Filter "*.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
  if($cand){ $txt = $cand.FullName } else { throw "Transcript .txt not found in $OutDir" }
}

# Split into parts
if($SplitParts -gt 1){
  $lines = Get-Content -LiteralPath $txt -Raw
  $parts = $lines -split "\r?\n"
  $mid = [int]([math]::Floor($parts.Length/2))
  $p1 = $parts[0..($mid-1)] -join [Environment]::NewLine
  $p2 = $parts[$mid..($parts.Length-1)] -join [Environment]::NewLine
  $out1 = Join-Path $OutDir ("$base.part1.txt")
  $out2 = Join-Path $OutDir ("$base.part2.txt")
  Set-Content -LiteralPath $out1 -Value $p1 -Encoding UTF8
  Set-Content -LiteralPath $out2 -Value $p2 -Encoding UTF8
  Write-Host "Transcript: $txt" -ForegroundColor Green
  Write-Host "Part1:     $out1" -ForegroundColor Green
  Write-Host "Part2:     $out2" -ForegroundColor Green
} else {
  Write-Host "Transcript: $txt" -ForegroundColor Green
}

# Cleanup temp
if($isUrl -and $workFile -and (Test-Path $workFile)){
  Remove-Item -LiteralPath $workFile -Force -ErrorAction SilentlyContinue
}
