#!/usr/bin/env bash
set -euo pipefail

# Configuration
TAG="${TAG:-v1.0-digital-dominion}"
MANIFEST="docs/audit/INTEGRITY_MANIFEST.md"

# Sealed script targets (adjust if paths differ)
FILES=(
  "scripts/deep_forge_scanner_SEALED.ps1"
  "scripts/ai_models_scanner_SEALED.ps1"
  "scripts/run_fleet_scan_SEALED.ps1"
)

# Ensure manifest directory exists
mkdir -p "$(dirname "$MANIFEST")"

# Verify files and collect metadata
missing=()
declare -A SIZE
declare -A HASH
for f in "${FILES[@]}"; do
  if [[ -f "$f" ]]; then
    SIZE["$f"]=$(wc -c <"$f" | tr -d ' ')
    if command -v sha256sum >/dev/null 2>&1; then
      HASH["$f"]=$(sha256sum "$f" | awk '{print $1}')
    else
      echo "sha256sum not found. Install coreutils or run from Git Bash." >&2
      exit 1
    fi
  else
    missing+=("$f")
  fi
done

if (( ${#missing[@]} > 0 )); then
  echo "Missing sealed files:" >&2
  printf ' - %s\n' "${missing[@]}" >&2
  exit 1
fi

# Git metadata
COMMIT_SHA=$(git rev-parse HEAD)
COMMIT_SUBJECT=$(git log -1 --pretty=%s)
AUTHOR_NAME=$(git log -1 --pretty=%an)
AUTHOR_EMAIL=$(git log -1 --pretty=%ae)
COMMIT_DATE=$(git log -1 --date=iso-strict --pretty=%cd)
TS_UTC=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# Render manifest
{
  echo "# INTEGRITY_MANIFEST"
  echo
  echo "## Digital Dominion Seal"
  echo "Tag: ${TAG}"
  echo "Commit SHA: ${COMMIT_SHA}"
  echo "Commit: ${COMMIT_SUBJECT}"
  echo "Author: ${AUTHOR_NAME} <${AUTHOR_EMAIL}>"
  echo "Timestamp (UTC): ${TS_UTC}"
  echo
  echo "## Sealed Scanner Scripts"
  echo "| File | Size (bytes) | SHA256 |"
  echo "|------|--------------:|--------|"
  for f in "${FILES[@]}"; do
    echo "| ${f} | ${SIZE[$f]} | ${HASH[$f]} |"
  done
  echo
  echo "## Verification Commands"
  echo '```'
  for f in "${FILES[@]}"; do
    echo "sha256sum ${f}"
  done
  echo '```'
  echo
  echo "## Change Policy"
  echo "Any modification to sealed scripts requires updating this manifest and creating a new annotated tag (v1.<minor>-digital-dominion)."
} > "$MANIFEST"

# Stage and commit
git add "$MANIFEST" "${FILES[@]}"
if ! git diff --cached --quiet; then
  git commit -m "docs(governance): populate integrity manifest for ${TAG}"
else
  echo "No changes to commit."
fi

# Tag
if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
  echo "Tag ${TAG} already exists. Skipping tag creation." >&2
else
  git tag -a "${TAG}" -m "Final Sovereignty Seal: Digital Dominion Achieved. Estate Clean."
fi

# Push
git push origin main
git push origin "${TAG}" || true

echo "Done. Manifest: ${MANIFEST} | Tag: ${TAG}"