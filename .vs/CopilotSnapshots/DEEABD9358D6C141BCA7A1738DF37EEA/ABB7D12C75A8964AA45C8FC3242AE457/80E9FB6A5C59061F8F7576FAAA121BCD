cmake_minimum_required(VERSION 3.10)
project(verify_evidence CXX)

set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

add_library(VerifyEvidenceLib STATIC VerifyEvidenceLib.cpp VerifyEvidenceLib.h)

# libsodium manual integration via LIBSODIUM_ROOT env var (portable archive layout)
if (DEFINED ENV{LIBSODIUM_ROOT})
    message(STATUS "Using LIBSODIUM_ROOT=$ENV{LIBSODIUM_ROOT}")
    set(LIBSODIUM_INC "$ENV{LIBSODIUM_ROOT}/include")
    # Prefer static release lib (v143 if present else any)
    if (EXISTS "$ENV{LIBSODIUM_ROOT}/x64/Release/v143/static/libsodium.lib")
        set(LIBSODIUM_LIB "$ENV{LIBSODIUM_ROOT}/x64/Release/v143/static/libsodium.lib")
    elseif (EXISTS "$ENV{LIBSODIUM_ROOT}/x64/Release/v142/static/libsodium.lib")
        set(LIBSODIUM_LIB "$ENV{LIBSODIUM_ROOT}/x64/Release/v142/static/libsodium.lib")
    elseif (EXISTS "$ENV{LIBSODIUM_ROOT}/x64/Debug/v143/static/libsodium.lib")
        set(LIBSODIUM_LIB "$ENV{LIBSODIUM_ROOT}/x64/Debug/v143/static/libsodium.lib")
    endif()
    if (LIBSODIUM_LIB AND EXISTS ${LIBSODIUM_INC})
        message(STATUS "Found libsodium: ${LIBSODIUM_LIB}")
        target_include_directories(VerifyEvidenceLib PRIVATE ${LIBSODIUM_INC})
        target_link_libraries(VerifyEvidenceLib ${LIBSODIUM_LIB})
        target_compile_definitions(VerifyEvidenceLib PRIVATE SODIUM_AVAILABLE)
    else()
        message(WARNING "libsodium not found at LIBSODIUM_ROOT")
    endif()
endif()

add_executable(Verify-Evidence Verify-Evidence.cpp)
target_link_libraries(Verify-Evidence PRIVATE VerifyEvidenceLib)
if (TARGET VerifyEvidenceLib)
    get_target_property(_defs VerifyEvidenceLib COMPILE_DEFINITIONS)
    if (_defs MATCHES "SODIUM_AVAILABLE")
        target_compile_definitions(Verify-Evidence PRIVATE SODIUM_AVAILABLE)
    endif()
endif()

enable_testing()
add_executable(verify_evidence_tests tests/verify_evidence_tests.cpp)
target_link_libraries(verify_evidence_tests PRIVATE VerifyEvidenceLib)
if (TARGET VerifyEvidenceLib)
    get_target_property(_defs VerifyEvidenceLib COMPILE_DEFINITIONS)
    if (_defs MATCHES "SODIUM_AVAILABLE")
        target_compile_definitions(verify_evidence_tests PRIVATE SODIUM_AVAILABLE)
    endif()
endif()
add_test(NAME verify_evidence_tests COMMAND verify_evidence_tests)
