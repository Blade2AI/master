cmake_minimum_required(VERSION 3.10)
project(verify_evidence CXX)

set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

add_library(VerifyEvidenceLib STATIC VerifyEvidenceLib.cpp VerifyEvidenceLib.h)

# ---- Libsodium detection (robust) ----
set(SODIUM_FOUND FALSE)
if(DEFINED ENV{LIBSODIUM_ROOT})
    set(LIBSODIUM_ROOT $ENV{LIBSODIUM_ROOT})
    message(STATUS "[libsodium] LIBSODIUM_ROOT=${LIBSODIUM_ROOT}")
    if(EXISTS "${LIBSODIUM_ROOT}/include/sodium.h")
        set(LIBSODIUM_INC "${LIBSODIUM_ROOT}/include")
        # Search recursively for libsodium.lib (prefer static Release first)
        set(_candidate_libs)
        file(GLOB_RECURSE _all_libs "${LIBSODIUM_ROOT}/*.lib")
        foreach(L ${_all_libs})
            # Prefer paths containing 'static' and 'Release'
            string(FIND "${L}" "libsodium.lib" _is_match)
            if(NOT _is_match EQUAL -1)
                list(APPEND _candidate_libs "${L}")
            endif()
        endforeach()
        if(_candidate_libs)
            # Sort to put Release/static earlier
            list(SORT _candidate_libs)
            foreach(CAND ${_candidate_libs})
                if(CAND MATCHES ".*Release.*static.*libsodium.lib")
                    set(LIBSODIUM_LIB ${CAND})
                    break()
                endif()
            endforeach()
            if(NOT LIBSODIUM_LIB)
                # Fallback: first candidate
                list(GET _candidate_libs 0 LIBSODIUM_LIB)
            endif()
        endif()
        if(LIBSODIUM_LIB AND EXISTS ${LIBSODIUM_LIB})
            message(STATUS "[libsodium] Using library: ${LIBSODIUM_LIB}")
            target_include_directories(VerifyEvidenceLib PRIVATE ${LIBSODIUM_INC})
            target_link_libraries(VerifyEvidenceLib ${LIBSODIUM_LIB})
            target_compile_definitions(VerifyEvidenceLib PRIVATE SODIUM_AVAILABLE)
            set(SODIUM_FOUND TRUE)
        else()
            message(WARNING "[libsodium] libsodium.lib not found under ${LIBSODIUM_ROOT}. Signature tests will be skipped.")
        endif()
    else()
        message(WARNING "[libsodium] sodium.h not found at ${LIBSODIUM_ROOT}/include. Provide a valid libsodium distribution.")
    endif()
else()
    message(STATUS "[libsodium] LIBSODIUM_ROOT not set. Build will use portable SHA256 only.")
endif()

add_executable(Verify-Evidence Verify-Evidence.cpp)
target_link_libraries(Verify-Evidence PRIVATE VerifyEvidenceLib)
if(SODIUM_FOUND)
    target_compile_definitions(Verify-Evidence PRIVATE SODIUM_AVAILABLE)
endif()

enable_testing()
add_executable(verify_evidence_tests tests/verify_evidence_tests.cpp)
target_link_libraries(verify_evidence_tests PRIVATE VerifyEvidenceLib)
if(SODIUM_FOUND)
    target_compile_definitions(verify_evidence_tests PRIVATE SODIUM_AVAILABLE)
endif()
add_test(NAME verify_evidence_tests COMMAND verify_evidence_tests)
