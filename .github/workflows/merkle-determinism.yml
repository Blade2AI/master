name: Merkle Root Determinism

on:
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/compute_merkle_root.py'
      - 'tests/test_merkle_determinism.py'
      - 'scripts/Seal-And-Anchor-Dual.ps1'
      - 'scripts/**'
      - 'agi/core/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'scripts/compute_merkle_root.py'
      - 'tests/test_merkle_determinism.py'
      - 'scripts/Seal-And-Anchor-Dual.ps1'
      - 'scripts/**'
      - 'agi/core/**'

jobs:
  merkle-determinism:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps (pytest only)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          python -m pip install pytest

      - name: Run unit test for merkle determinism
        run: |
          pytest -q tests/test_merkle_determinism.py

      - name: Double-run merkle root on synthetic ledger
        shell: bash
        run: |
          echo '{"events":[{"id":1,"payload":"alpha"},{"id":2,"payload":"beta"},{"id":3,"payload":"gamma"}]}' > ledger_a.json
          python scripts/compute_merkle_root.py ledger_a.json > first.txt 2>&1 || true
          python scripts/compute_merkle_root.py ledger_a.json > second.txt 2>&1 || true
          echo "FIRST:" && cat first.txt
          echo "SECOND:" && cat second.txt
          diff first.txt second.txt || (echo 'Merkle root mismatch between runs' && exit 1)

      - name: Reordered events should yield same root
        shell: bash
        run: |
          echo '{"events":[{"id":3,"payload":"gamma"},{"id":2,"payload":"beta"},{"id":1,"payload":"alpha"}]}' > ledger_b.json
          python scripts/compute_merkle_root.py ledger_b.json > third.txt 2>&1 || true
          python scripts/compute_merkle_root.py ledger_a.json > baseline.txt 2>&1 || true
          echo "BASELINE:" && cat baseline.txt
          echo "REORDERED:" && cat third.txt
          diff baseline.txt third.txt || (echo 'Merkle root changed after reorder (non-deterministic)' && exit 1)

      - name: Summary
        run: echo 'Merkle determinism gate passed.'
