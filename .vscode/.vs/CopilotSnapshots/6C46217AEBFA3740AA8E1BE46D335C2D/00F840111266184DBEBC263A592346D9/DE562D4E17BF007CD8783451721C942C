param(
    [string[]]$Targets = @('pc-1','pc-2','pc-3','pc-4'),
    [string]$NasRoot = "\\dxp4800plus-67ba\ops",
    [string]$WorkspaceRepo = "https://github.com/PrecisePointway/master",
    [switch]$InstallLiveShare,
    [switch]$SetupTasks
)

$ws = Split-Path -Parent $PSScriptRoot

Write-Host "🚀 Deploying Live Share setup to fleet..." -ForegroundColor Green

# Ensure NAS structure for Live Share
$liveShareDir = Join-Path $NasRoot 'LiveShare'
New-Item -ItemType Directory -Force -Path $liveShareDir | Out-Null

# Package Live Share scripts
$timestamp = (Get-Date).ToString('yyyyMMdd_HHmmss')
$packageName = "liveshare_setup_$timestamp"
$packageDir = Join-Path $NasRoot "Packages\$packageName"
New-Item -ItemType Directory -Force -Path $packageDir | Out-Null

# Copy scripts to package
Write-Host "📦 Packaging Live Share scripts..." -ForegroundColor Yellow
Copy-Item -Path (Join-Path $ws 'scripts\Start-LiveShare-Host.ps1') -Destination $packageDir -Force
Copy-Item -Path (Join-Path $ws 'scripts\Join-LiveShare-Guest.ps1') -Destination $packageDir -Force
Copy-Item -Path (Join-Path $ws 'scripts\Start-Collab.ps1') -Destination $packageDir -Force
Copy-Item -Path (Join-Path $ws 'scripts\End-Collab.ps1') -Destination $packageDir -Force

# Copy tasks.json template
$tasksTemplate = Join-Path $ws '.vscode\tasks.json'
if (Test-Path $tasksTemplate) {
    Copy-Item -Path $tasksTemplate -Destination $packageDir -Force
}

foreach ($target in $Targets) {
    $host = $target.ToLower()
    Write-Host "🔧 Setting up $host..." -ForegroundColor Cyan
    
    # 1. Deploy Live Share scripts
    Write-Host "  📂 Deploying scripts to $host"
    & "$ws\scripts\Queue-Command.ps1" -Hosts $host -Type deploy -Package $packageDir -Dest 'C:\ops\LiveShare'
    
    # 2. Install VS Code if not present (optional)
    $vsCodeCheck = @"
if (-not (Get-Command code -ErrorAction SilentlyContinue)) {
    Write-Output "Installing VS Code..."
    winget install -e --id Microsoft.VisualStudioCode --accept-package-agreements --accept-source-agreements
} else {
    Write-Output "VS Code already installed"
}
"@
    
    # 3. Install Live Share extension if requested
    if ($InstallLiveShare) {
        Write-Host "  🔌 Installing Live Share extension on $host"
        $liveShareInstall = @"
$vsCodeCheck
Start-Sleep -Seconds 5
code --install-extension ms-vsliveshare.vsliveshare --force
Write-Output "Live Share extension installed"
"@
        & "$ws\scripts\Queue-Command.ps1" -Hosts $host -Code $liveShareInstall | Out-Null
    }
    
    # 4. Clone/update repository
    Write-Host "  📥 Setting up repository on $host"
    $repoSetup = @"
`$repoDir = 'C:\Development\PrecisePointway'
if (-not (Test-Path `$repoDir)) {
    New-Item -ItemType Directory -Force -Path (Split-Path `$repoDir) | Out-Null
    git clone $WorkspaceRepo `$repoDir
    Write-Output "Repository cloned to `$repoDir"
} else {
    Set-Location `$repoDir
    git pull
    Write-Output "Repository updated at `$repoDir"
}
"@
    & "$ws\scripts\Queue-Command.ps1" -Hosts $host -Code $repoSetup | Out-Null
    
    # 5. Setup workspace tasks if requested
    if ($SetupTasks) {
        Write-Host "  ⚙️  Setting up VS Code tasks on $host"
        $taskSetup = @"
`$repoDir = 'C:\Development\PrecisePointway'
`$vscodeDir = Join-Path `$repoDir '.vscode'
New-Item -ItemType Directory -Force -Path `$vscodeDir | Out-Null
Copy-Item -Path 'C:\ops\LiveShare\tasks.json' -Destination `$vscodeDir -Force
Write-Output "VS Code tasks configured"
"@
        & "$ws\scripts\Queue-Command.ps1" -Hosts $host -Code $taskSetup | Out-Null
    }
    
    # 6. Create convenience shortcuts
    Write-Host "  🔗 Creating shortcuts on $host"
    $shortcutSetup = @"
`$desktop = [Environment]::GetFolderPath('Desktop')
`$repoDir = 'C:\Development\PrecisePointway'

# Create desktop shortcut for opening workspace
`$shell = New-Object -ComObject WScript.Shell
`$shortcut = `$shell.CreateShortcut("`$desktop\PrecisePointway Workspace.lnk")
`$shortcut.TargetPath = 'code'
`$shortcut.Arguments = "`$repoDir"
`$shortcut.WorkingDirectory = `$repoDir
`$shortcut.IconLocation = 'code.exe,0'
`$shortcut.Description = 'Open PrecisePointway in VS Code'
`$shortcut.Save()

# Create shortcut for joining Live Share
`$joinShortcut = `$shell.CreateShortcut("`$desktop\Join Live Share.lnk")
`$joinShortcut.TargetPath = 'powershell.exe'
`$joinShortcut.Arguments = '-NoProfile -ExecutionPolicy Bypass -File "C:\ops\LiveShare\Join-LiveShare-Guest.ps1" -AutoOpen'
`$joinShortcut.WorkingDirectory = 'C:\ops\LiveShare'
`$joinShortcut.Description = 'Join Live Share Session'
`$joinShortcut.Save()

Write-Output "Desktop shortcuts created"
"@
    & "$ws\scripts\Queue-Command.ps1" -Hosts $host -Code $shortcutSetup | Out-Null
}

# Create a status dashboard script
$dashboardScript = @"
param([switch]`$Continuous)

do {
    Clear-Host
    Write-Host "🔄 Live Share Fleet Status - $((Get-Date).ToString('HH:mm:ss'))" -ForegroundColor Green
    Write-Host "=" * 60
    
    `$nasRoot = '$NasRoot'
    `$statusFile = Join-Path `$nasRoot 'LiveShareStatus.json'
    `$linkFile = Join-Path `$nasRoot 'LiveShareLink.txt'
    
    if (Test-Path `$statusFile) {
        try {
            `$status = Get-Content `$statusFile | ConvertFrom-Json
            Write-Host "📊 Session Status: " -NoNewline
            switch (`$status.Status) {
                'Active' { Write-Host `$status.Status -ForegroundColor Green }
                'Stopped' { Write-Host `$status.Status -ForegroundColor Red }
                default { Write-Host `$status.Status -ForegroundColor Yellow }
            }
            Write-Host "🖥️  Host: `$(`$status.Host)"
            Write-Host "⏰ Updated: `$(`$status.Timestamp)"
            if (`$status.Workspace) { Write-Host "📁 Workspace: `$(`$status.Workspace)" }
            if (`$status.Link) { Write-Host "🔗 Link: `$(`$status.Link)" }
        } catch {
            Write-Host "❌ Could not parse status file" -ForegroundColor Red
        }
    } else {
        Write-Host "📊 No active session found" -ForegroundColor Yellow
    }
    
    Write-Host ""
    Write-Host "🎯 Fleet Targets: $($Targets -join ', ')"
    Write-Host "📡 NAS Root: `$nasRoot"
    
    if (`$Continuous) {
        Write-Host ""
        Write-Host "Press Ctrl+C to stop monitoring..."
        Start-Sleep -Seconds 10
    }
} while (`$Continuous)
"@

Set-Content -Path (Join-Path $packageDir 'Show-LiveShareStatus.ps1') -Value $dashboardScript -Encoding UTF8

Write-Host ""
Write-Host "✅ Live Share fleet deployment completed!" -ForegroundColor Green
Write-Host "📦 Package: $packageName"
Write-Host ""
Write-Host "🎯 Next Steps:"
Write-Host "  1. On the HOST PC: Run 'LiveShare: Start Host Session' task"
Write-Host "  2. On GUEST PCs: Run 'LiveShare: Join Session' task or use desktop shortcut"
Write-Host "  3. Monitor status with: PowerShell $packageDir\Show-LiveShareStatus.ps1 -Continuous"
Write-Host ""
Write-Host "💡 Available VS Code Tasks:"
Write-Host "  - LiveShare: Start Host Session"
Write-Host "  - LiveShare: Join Session"
Write-Host "  - LiveShare: Check Session Status"
Write-Host "  - Build: C++ Debug/Release (with C++14 standard)"